name: DROP Backend CI

on:
    pull_request:
        paths:
            - "**"
            - ".github/**"
        branches: [ main, dev ]
    push:
        branches: [ main, dev ]

permissions:
    contents: read
    checks: write
    pull-requests: write

jobs:
    backend-test:
        runs-on: ubuntu-latest

        env:
            SPRING_PROFILES_ACTIVE: test
            SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1;DATABASE_TO_UPPER=false
            SPRING_DATASOURCE_USERNAME: sa
            SPRING_DATASOURCE_PASSWORD: ""
            INCLUDE_INTEGRATION: false

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Ensure base commit is fetched (PR only)
              if: github.event_name == 'pull_request'
              run: |
                  BASE_SHA='${{ github.event.pull_request.base.sha }}'
                  if ! git cat-file -e "$BASE_SHA^{commit}" 2>/dev/null; then
                    git fetch --no-tags --prune origin "$BASE_SHA":"refs/remotes/origin/base-sha"
                  fi

            - name: Set up Java 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 21

            - name: Cache Gradle packages
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: ${{ runner.os }}-gradle-

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Build without tests
              run: ./gradlew build -x test --no-daemon

            - name: Create env file from GitHub Secret
              run: |
                echo "${{ secrets.ENV_FILE }}" > .env.properties

            - name: Run Unit Tests
              run: ./gradlew test \
                -Dspring.config.import=optional:file:.env.properties \
                --no-daemon

            - name: Run Full Tests (Unit + Integration)
              run: ./gradlew fullTest \
                -Dspring.config.import=optional:file:.env.properties \
                --no-daemon


            - name: Generate JaCoCo Unit Test Report
              if: always()
              run: ./gradlew jacocoTestReport --no-daemon

            - name: Generate JaCoCo Full Test Report
              if: always()
              run: ./gradlew clean jacocoFullTestReport --rerun-tasks --no-daemon

            # ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÌååÏã±
            - name: Parse test results
              if: always()
              id: test_results
              run: |
                  # fullTest Í≤∞Í≥º Ïö∞ÏÑ† ÏÇ¨Ïö©
                  TEST_DIR="build/test-results/fullTest"
                  
                  if [ -d "$TEST_DIR" ]; then
                    TOTAL=0
                    FAILURES=0
                    SKIPPED=0
                  
                    # XML ÌååÏùº ÌååÏã±
                    for xml_file in "$TEST_DIR"/TEST-*.xml; do
                      if [ -f "$xml_file" ]; then
                        tests=$(grep -o 'tests="[0-9]*"' "$xml_file" | head -1 | grep -o '[0-9]*' || echo "0")
                        failures=$(grep -o 'failures="[0-9]*"' "$xml_file" | head -1 | grep -o '[0-9]*' || echo "0")
                        skipped=$(grep -o 'skipped="[0-9]*"' "$xml_file" | head -1 | grep -o '[0-9]*' || echo "0")
                  
                        TOTAL=$((TOTAL + tests))
                        FAILURES=$((FAILURES + failures))
                        SKIPPED=$((SKIPPED + skipped))
                      fi
                    done
                  
                    PASSED=$((TOTAL - FAILURES - SKIPPED))
                  
                    echo "Test Results: Total=$TOTAL, Passed=$PASSED, Failed=$FAILURES, Skipped=$SKIPPED"
                    echo "total=$TOTAL" >> $GITHUB_OUTPUT
                    echo "passed=$PASSED" >> $GITHUB_OUTPUT
                    echo "failed=$FAILURES" >> $GITHUB_OUTPUT
                    echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
                  else
                    echo "No test results found"
                    echo "total=0" >> $GITHUB_OUTPUT
                    echo "passed=0" >> $GITHUB_OUTPUT
                    echo "failed=0" >> $GITHUB_OUTPUT
                    echo "skipped=0" >> $GITHUB_OUTPUT
                  fi

            - name: Publish Unit Test Results
              if: always()
              uses: EnricoMi/publish-unit-test-result-action@v2
              with:
                  files: |
                      build/test-results/test/*.xml
                  check_run: true
                  comment_mode: always

            - name: Publish Full Test Results
              if: always()
              uses: EnricoMi/publish-unit-test-result-action@v2
              with:
                  files: |
                      build/test-results/fullTest/*.xml
                  check_run: true
                  comment_mode: always

            - name: Upload failed-tests.txt (if exists)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: failed-tests
                  path: build/reports/tests/failed-tests.txt
                  if-no-files-found: ignore

            - name: Upsert PR comment with failed tests
              if: always()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const path = 'build/reports/tests/failed-tests.txt';
                      const MARK = '<!-- FAILED-TESTS-SUMMARY -->';
                      
                      function buildBody(textBlock) {
                        return [
                          MARK,
                          '### ‚ùå Failed Tests (from Gradle summary)',
                          '',
                          '<details><summary>Expand</summary>',
                          '',
                          '```text',
                          textBlock,
                          '```',
                          '',
                          '</details>'
                        ].join('\n');
                      }
                      
                      if (!context.payload.pull_request) {
                        core.info('Not a PR event, skip commenting');
                        return;
                      }
                      
                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.payload.pull_request.number,
                        per_page: 100
                      });
                      
                      if (!fs.existsSync(path)) {
                        const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
                        if (existing) {
                          await github.rest.issues.deleteComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            comment_id: existing.id
                          });
                        }
                        return;
                      }
                      
                      const content = fs.readFileSync(path, 'utf8').trim();
                      if (!content || content === 'No failures üéâ') {
                        const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
                        if (existing) {
                          await github.rest.issues.deleteComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            comment_id: existing.id
                          });
                        }
                        return;
                      }
                      
                      const body = buildBody(content);
                      const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existing.id,
                          body
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.payload.pull_request.number,
                          body
                        });
                      }

            - name: Upload JaCoCo Unit Test HTML
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: jacoco-unit-html
                  path: build/reports/jacoco/html
                  if-no-files-found: warn

            - name: Upload JaCoCo Full Test HTML
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: jacoco-full-html
                  path: build/reports/jacocoFull/html
                  if-no-files-found: warn

            - name: Upload JaCoCo XML Reports
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: jacoco-xml-reports
                  path: |
                      build/reports/jacoco/xml/jacocoTestReport.xml
                      build/reports/jacocoFull/xml/jacocoFullTestReport.xml
                  if-no-files-found: warn

            - name: Install xmllint
              if: always()
              run: sudo apt-get update && sudo apt-get install -y libxml2-utils

            - name: Compute coverage percentage
              if: always() && github.event_name == 'pull_request'
              id: coverage
              run: |
                  # JaCoCo XML Î¶¨Ìè¨Ìä∏ Ï∞æÍ∏∞ (fullTest Ïö∞ÏÑ†)
                  XML="build/reports/jacocoFull/xml/jacocoFullTestReport.xml"
                  if [ ! -f "$XML" ]; then
                    XML="build/reports/jacoco/xml/jacocoTestReport.xml"
                  fi
                  
                  if [ -f "$XML" ]; then
                    echo "Using coverage XML: $XML"
                  
                    # LINE Ïª§Î≤ÑÎ¶¨ÏßÄ Í≥ÑÏÇ∞
                    COVERED=$(xmllint --xpath "string(sum(//counter[@type='LINE']/@covered))" "$XML" 2>/dev/null || echo "0")
                    MISSED=$(xmllint --xpath "string(sum(//counter[@type='LINE']/@missed))" "$XML" 2>/dev/null || echo "0")
                  
                    # Ïà´Ïûê Î≥ÄÌôò
                    COVERED=${COVERED%.*}
                    MISSED=${MISSED%.*}
                  
                    if [ "$COVERED" -eq 0 ] && [ "$MISSED" -eq 0 ]; then
                      PCT="0"
                    else
                      TOTAL=$((COVERED + MISSED))
                      PCT=$(awk "BEGIN { printf \"%.2f\", ($COVERED/$TOTAL)*100 }")
                    fi
                  
                    echo "Coverage: $COVERED covered, $MISSED missed = $PCT%"
                    echo "pct=$PCT" >> $GITHUB_OUTPUT
                    echo "covered=$COVERED" >> $GITHUB_OUTPUT
                    echo "missed=$MISSED" >> $GITHUB_OUTPUT
                  else
                    echo "No coverage XML found"
                    echo "pct=0" >> $GITHUB_OUTPUT
                    echo "covered=0" >> $GITHUB_OUTPUT
                    echo "missed=0" >> $GITHUB_OUTPUT
                  fi

            -   name: Build detailed coverage markdown
                if: always() && github.event_name == 'pull_request'
                id: coverage_details
                continue-on-error: true
                run: |
                    # Î¶¨Ìè¨Ìä∏ Í≤ΩÎ°ú Í≤∞Ï†ï
                    XML="build/reports/jacocoFull/xml/jacocoFullTestReport.xml"
                    if [ ! -f "$XML" ]; then
                      ALT="build/reports/jacoco/xml/jacocoTestReport.xml"
                      if [ -f "$ALT" ]; then
                        XML="$ALT"
                      else
                        echo "details=No coverage report found." >> $GITHUB_OUTPUT
                        exit 0
                      fi
                    fi
                    echo "Using coverage XML: $XML"
                    
                    export XML_PATH="$XML"
                    
                    # PR Î≥ÄÍ≤Ω ÌååÏùº ÏàòÏßë (Java ÌååÏùºÎßå)
                    BASE_SHA='${{ github.event.pull_request.base.sha }}'
                    HEAD_SHA='${{ github.sha }}'
                    
                    # Î≤†Ïù¥Ïä§ Ïª§Î∞ã ÌôïÏù∏
                    if ! git cat-file -e "$BASE_SHA^{commit}" 2>/dev/null; then
                      git fetch --no-tags --prune origin "$BASE_SHA":"refs/remotes/origin/base-sha" || true
                    fi
                    
                    git diff --name-only "$BASE_SHA" "$HEAD_SHA" \
                      | grep -E '^src/main/java/.*\.java$' > /tmp/changed-java.txt || true
                    
                    echo "Changed Java files:"
                    cat /tmp/changed-java.txt || true
                    echo
                    
                    python3 <<EOF > /tmp/coverage_details.md
                    import os
                    import sys
                    import xml.etree.ElementTree as ET
                    from pathlib import Path
                  
                    # XML Í≤ΩÎ°úÎ•º Î™ÖÎ†πÏ§Ñ Ïù∏ÏûêÎÇò ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Î∞õÍ∏∞
                    xml_path = os.environ.get('XML_PATH') or sys.argv[1] if len(sys.argv) > 1 else None

                    if not xml_path or not os.path.exists(xml_path):
                        print("### üìä ÏΩîÎìú Ïª§Î≤ÑÎ¶¨ÏßÄ Î¶¨Ìè¨Ìä∏")
                        print("> Î¶¨Ìè¨Ìä∏Î•º ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§. XML ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.")
                        sys.exit(0)
                    
                    try:
                        root = ET.parse(xml_path).getroot()
    
                        def sum_counter(node, ctype):
                            for c in node.findall("counter"):
                                if c.get("type") == ctype:
                                    return int(c.get("covered", "0")), int(c.get("missed", "0"))
                            return 0, 0
    
                        # Ï†ÑÏ≤¥ Ïª§Î≤ÑÎ¶¨ÏßÄ
                        tot_cov, tot_miss = sum_counter(root, "LINE")
                        tot_pct = (tot_cov / (tot_cov + tot_miss) * 100) if (tot_cov + tot_miss) else 0.0
                      
                      # Ìå®ÌÇ§ÏßÄÎ≥Ñ Ïª§Î≤ÑÎ¶¨ÏßÄ
                        pkg_rows = []
                        for p in root.findall("package"):
                            pcov, pmiss = sum_counter(p, "LINE")
                            if pcov + pmiss == 0:
                                for c in p.findall("class"):
                                    cc, cm = sum_counter(c, "LINE")
                                    pcov += cc; pmiss += cm
                            ppct = (pcov / (pcov + pmiss) * 100) if (pcov + pmiss) else 0.0
                            pkg_rows.append((p.get("name","(default)"), pcov, pmiss, ppct))
                        pkg_rows.sort(key=lambda r: r[3])
    
                        # ÌÅ¥ÎûòÏä§Î≥Ñ Ïª§Î≤ÑÎ¶¨ÏßÄ
                        class_rows = []
                        for p in root.findall("package"):
                            for c in p.findall("class"):
                                cc, cm = sum_counter(c, "LINE")
                                total = cc + cm
                                pct = (cc/total*100) if total else 0.0
                                cname = c.get("name","(unknown)").replace("/", ".")
                                class_rows.append((cname, cc, cm, pct, total))
                        class_rows.sort(key=lambda r: (r[3], -r[4]))
    
                        # Î≥ÄÍ≤Ω ÌååÏùº Îß§Ìïë
                        changed_rows = []
                        changed_file_list = Path("/tmp/changed-java.txt")
                        if changed_file_list.exists():
                            for line in changed_file_list.read_text().splitlines():
                                line = line.strip()
                                if not line: continue
                                if line.startswith("src/main/java/"):
                                    rel = line[len("src/main/java/"):]
                                    if rel.endswith(".java"):
                                        rel = rel[:-5]
                                    fqn = rel.replace("/", ".")
                                    
                                    matches = [r for r in class_rows if r[0].startswith(fqn)]
                                    if matches:
                                        cov = sum(m[1] for m in matches)
                                        miss = sum(m[2] for m in matches)
                                        total = cov + miss
                                        pct = (cov/total*100) if total else 0.0
                                        changed_rows.append((line, fqn, cov, miss, pct, total))
                                    else:
                                        changed_rows.append((line, fqn, 0, 0, 0.0, 0))
                            changed_rows.sort(key=lambda r: (r[4], -r[5]))
    
                        def fmt_pct(x): return f"{x:.2f}%"
    
                        print("### üìä ÏΩîÎìú Ïª§Î≤ÑÎ¶¨ÏßÄ Î¶¨Ìè¨Ìä∏\\n")
                        print(f"**Ï†ÑÏ≤¥ ÎùºÏù∏ Ïª§Î≤ÑÎ¶¨ÏßÄ:** {fmt_pct(tot_pct)} ({tot_cov} covered / {tot_cov+tot_miss} lines)\\n")
    
                        if pkg_rows:
                            print("<details><summary><b>Ìå®ÌÇ§ÏßÄÎ≥Ñ Ïª§Î≤ÑÎ¶¨ÏßÄ (ÎÇÆÏùÄ Ïàú)</b></summary>\\n")
                            print("| Ìå®ÌÇ§ÏßÄ | ÎùºÏù∏ % | Ïª§Î≤ÑÎê® | ÎÜìÏπ® |")
                            print("|---|---:|---:|---:|")
                            for (name, cov, miss, pct) in pkg_rows:
                                print(f"| \`{name}\` | {fmt_pct(pct)} | {cov} | {miss} |")
                            print("\\n</details>\\n")
    
                        print("<details open><summary><b>Ïª§Î≤ÑÎ¶¨ÏßÄÍ∞Ä ÎÇÆÏùÄ ÌÅ¥ÎûòÏä§ (Top 15)</b></summary>\\n")
                        print("| ÌÅ¥ÎûòÏä§ | ÎùºÏù∏ % | Ïª§Î≤ÑÎê® | ÎÜìÏπ® |")
                        print("|---|---:|---:|---:|")
                        for (cname, cov, miss, pct, total) in class_rows[:15]:
                            print(f"| \`{cname}\` | {fmt_pct(pct)} | {cov} | {miss} |")
                        print("\\n</details>\\n")
    
                        if changed_rows:
                            print("<details open><summary><b>Ïù¥ PRÏóêÏÑú Î≥ÄÍ≤ΩÎêú ÌååÏùºÎì§</b></summary>\\n")
                            print("| ÌååÏùº (PR) | ÌÅ¥ÎûòÏä§ | ÎùºÏù∏ % | Ïª§Î≤ÑÎê® | ÎÜìÏπ® |")
                            print("|---|---|---:|---:|---:|")
                            for (src, fqn, cov, miss, pct, total) in changed_rows:
                                print(f"| \`{src}\` | \`{fqn}\` | {fmt_pct(pct)} | {cov} | {miss} |")
                            print("\\n</details>\\n")
                        else:
                            print("> Ïù¥ PRÏóêÎäî Java ÏÜåÏä§ ÌååÏùº Î≥ÄÍ≤ΩÏù¥ ÏóÜÏäµÎãàÎã§.\\n")
    
                    except Exception as e:
                        print(f"### üìä ÏΩîÎìú Ïª§Î≤ÑÎ¶¨ÏßÄ Î¶¨Ìè¨Ìä∏")
                        print(f"> Ïò§Î•ò Î∞úÏÉù: {e}")
                        print("> Í∏∞Î≥∏ Î¶¨Ìè¨Ìä∏Îßå ÌëúÏãúÎê©ÎãàÎã§.")
                        EOF
                      
                      {
                          echo 'details<<EOF'
                          cat /tmp/coverage_details.md
                          echo 'EOF'
                      } >> $GITHUB_OUTPUT

            - name: Upsert PR coverage comment
              if: always() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              env:
                  PCT: ${{ steps.coverage.outputs.pct }}
                  COVERED: ${{ steps.coverage.outputs.covered }}
                  MISSED: ${{ steps.coverage.outputs.missed }}
                  DETAILS: ${{ steps.coverage_details.outputs.details }}
              with:
                  script: |
                      const MARK = '<!-- JACOCO-COVERAGE-REPORT -->';
                      const pct = process.env.PCT || '0';
                      const covered = process.env.COVERED || '0';
                      const missed = process.env.MISSED || '0';
                      const details = process.env.DETAILS || '';
                      const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
                      
                      const body = `${MARK}
                      ## üß™ ÏΩîÎìú Ïª§Î≤ÑÎ¶¨ÏßÄ Î¶¨Ìè¨Ìä∏
                      
                      ### üìà Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ
                      **ÎùºÏù∏ Ïª§Î≤ÑÎ¶¨ÏßÄ:** ${pct}% (${covered} lines covered / ${parseInt(covered) + parseInt(missed)} total)
                      
                      ${details}
                      
                      ### üîó Î¶¨Ìè¨Ìä∏ Î≥¥Í∏∞
                      - **HTML Î¶¨Ìè¨Ìä∏**: [jacoco-full-html ÏïÑÌã∞Ìå©Ìä∏](${runUrl})
                      - **ÌÖåÏä§Ìä∏ Í≤∞Í≥º**: [ÌÖåÏä§Ìä∏ Î¶¨Ìè¨Ìä∏](${runUrl})
                      - **Ïã§Ìå® ÌÖåÏä§Ìä∏**: PR ÏΩîÎ©òÌä∏ ÌôïÏù∏
                      
                      > *ü§ñ Ïù¥ Î¶¨Ìè¨Ìä∏Îäî DROP CIÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*`;
                      
                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.payload.pull_request.number,
                        per_page: 100
                      });
                      
                      const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existing.id,
                          body
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.payload.pull_request.number,
                          body
                        });
                      }

            # Slack ÏïåÎ¶º (ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÏôÄ Ïª§Î≤ÑÎ¶¨ÏßÄ Ìè¨Ìï®)
            - name: Slack ÏïåÎ¶º (ÏÑ±Í≥µ)
              if: success()
              uses: slackapi/slack-github-action@v1
              continue-on-error: true
              with:
                  payload: |
                      {
                        "text": "‚úÖ Backend CI ÏÑ±Í≥µ - ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nAuthor: ${{ github.actor }}\nTests: ‚úÖ ${{ steps.test_results.outputs.passed || 0 }} passed\nCoverage: ${{ steps.coverage.outputs.pct || 0 }}%",
                        "blocks": [
                          {
                            "type": "header",
                            "text": {
                              "type": "plain_text",
                              "text": "‚úÖ Backend CI ÏÑ±Í≥µ",
                              "emoji": true
                            }
                          },
                          {
                            "type": "section",
                            "fields": [
                              {
                                "type": "mrkdwn",
                                "text": "*Branch/PR*\n${{ github.ref_name }}"
                              },
                              {
                                "type": "mrkdwn",
                                "text": "*Author*\n${{ github.actor }}"
                              }
                            ]
                          },
                          {
                            "type": "section",
                            "fields": [
                              {
                                "type": "mrkdwn",
                                "text": "*Tests*\n‚úÖ ${{ steps.test_results.outputs.passed || 0 }} passed\n‚ùå ${{ steps.test_results.outputs.failed || 0 }} failed\n‚è≠Ô∏è ${{ steps.test_results.outputs.skipped || 0 }} skipped"
                              },
                              {
                                "type": "mrkdwn",
                                "text": "*Coverage*\n${{ steps.coverage.outputs.pct || 0 }}%"
                              }
                            ]
                          },
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "üîó <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Î°úÍ∑∏ ÌôïÏù∏ÌïòÍ∏∞>"
                            }
                          }
                        ]
                      }
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

            - name: Slack ÏïåÎ¶º (Ïã§Ìå®)
              if: failure()
              uses: slackapi/slack-github-action@v1
              continue-on-error: true
              with:
                  payload: |
                      {
                        "text": "‚ùå Backend CI Ïã§Ìå® - ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nAuthor: ${{ github.actor }}\nTests: ‚úÖ ${{ steps.test_results.outputs.passed || 0 }} passed, ‚ùå ${{ steps.test_results.outputs.failed || 0 }} failed\nView: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "blocks": [
                          {
                            "type": "header",
                            "text": {
                              "type": "plain_text",
                              "text": "‚ùå Backend CI Ïã§Ìå®",
                              "emoji": true
                            }
                          },
                          {
                            "type": "section",
                            "fields": [
                              {
                                "type": "mrkdwn",
                                "text": "*Branch/PR*\n${{ github.ref_name }}"
                              },
                              {
                                "type": "mrkdwn",
                                "text": "*Author*\n${{ github.actor }}"
                              }
                            ]
                          },
                          {
                            "type": "section",
                            "fields": [
                              {
                                "type": "mrkdwn",
                                "text": "*Tests*\n‚úÖ ${{ steps.test_results.outputs.passed || 0 }} passed\n‚ùå ${{ steps.test_results.outputs.failed || 0 }} failed"
                              },
                              {
                                "type": "mrkdwn",
                                "text": "*Coverage*\n${{ steps.coverage.outputs.pct || 0 }}%"
                              }
                            ]
                          },
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "üîó <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Î°úÍ∑∏ ÌôïÏù∏ÌïòÍ∏∞>"
                            }
                          }
                        ]
                      }
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
